---
title : "iOS Memory Deep Dive"
abstract: "Discover how memory graphs can be used."

displayToc: true
---

# WWDC 2018: iOS Memory Deep Dive
Find hereafter a detailed summary of the above named video which belongs to a [taxonomy&nbsp;of&nbsp;some&nbsp;WWDC&nbsp;footages](../../).

The original video is available on the **official Apple website** ([session&nbsp;416](https://developer.apple.com/videos/play/wwdc2018/416/)).

![](../../../../../images/iOSdev/wwdc18-416.png)

"Discover how **memory graphs** can be used to get a close up look at what is contributing to an **app's memory footprint**. Understand the true **memory cost of an image**. Learn some tips and tricks for **reducing the memory footprint** of an app."
</br></br>The various contents of this video are indicated hereunder:
- [Memory&nbsp;footprint](#memory-footprint)

- [Tools&nbsp;for&nbsp;profiling&nbsp;footprint](#tools-for-profiling-footprint)

- [Images](#images)

- [Background&nbsp;optimization](#background-optimization)

- [Demo](#demo)

</br>Most of the illustrations are parts of the Apple presentations and may be available at the `Resources` section inside the `Overview` sheet of each video.
</br>Hereafter, the underlined elements lead directly to the playback of the WWDC video at the appropriate moment.
</br>
## [Memory&nbsp;footprint](https://developer.apple.com/videos/play/wwdc2018/416/?time=88)

<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active"
           data-toggle="tab" 
           href="#MemoryFootprintOverview"
           id="MemoryFootprintOverview_tab"
           role="tab" 
           aria-selected="true">Overview</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#MemoryFootprintMemories"
           id="MemoryFootprintMemories_tab"
           role="tab" 
           aria-selected="false">Memories</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#MemoryFootprintFramework"
           id="MemoryFootprintFramework_tab"
           role="tab" 
           aria-selected="false">Framework</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#MemoryFootprintWarning"
           id="MemoryFootprintWarning_tab"
           role="tab" 
           aria-selected="false">Warning</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#MemoryFootprintLimit"
           id="MemoryFootprintLimit_tab"
           role="tab" 
           aria-selected="false">Limit</a>
    </li>
</ul>

<div class="tab-content">
<div class="tab-pane show active" id="MemoryFootprintOverview" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=100">ðŸŽ¬ (01:40)</a>

Dealing with the memory footprint always points out the management of the **memory pages** that are detailed in this footage.

![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintOverview.png)

</div>

<div class="tab-pane" id="MemoryFootprintMemories" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=203">ðŸŽ¬ (03:23)</a>

An app's segments of memory are divided into three parts: **dirty**, **compressed** and **clean**.

![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintMemories_1.png)
</br>

The [memory&nbsp;compressor](https://developer.apple.com/videos/play/wwdc2018/416/?time=297) is a good way to obtain more space with unused pages. 

![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintMemories_2.png)
</div>

<div class="tab-pane" id="MemoryFootprintFramework" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=267">ðŸŽ¬ (04:27)</a>

A good practice is to use the singletons and the global initializers of the frameworks to alleviate the amount of dirty memory generated by their usage. 

![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintFramework.png)

</div>

<div class="tab-pane" id="MemoryFootprintWarning" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=346">ðŸŽ¬ (05:46)</a>

A **memory warning** may be brought about by multiple reasons...
![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintWarning_1.png)

... and [purging&nbsp;the&nbsp;cache&nbsp;memory](https://developer.apple.com/videos/play/wwdc2018/416/?time=385) is not necessary the best way to follow.
![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintWarning_2.png)

Finally, the **[cache&nbsp;usage](https://developer.apple.com/videos/play/wwdc2018/416/?time=423) is recommended** but mustn't be overkill failing which the contrary goal might be reached. 

![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintWarning_3.png)

</div>

<div class="tab-pane" id="MemoryFootprintLimit" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=456">ðŸŽ¬ (07:36)</a>

The **app's footprint** is clearly defined as the **dirty** and **compressed** memories.

[Reaching&nbsp;its&nbsp;limit](https://developer.apple.com/videos/play/wwdc2018/416/?time=473) by raising an exception may be induced not only by these memory segments but also by the hardware and functional aspects.

![](../../../../../images/iOSdev/wwdc18-416-MemoryFootprintLimit.png)

</div>
</div>

</br></br>
## [Tools&nbsp;for&nbsp;profiling&nbsp;footprint](https://developer.apple.com/videos/play/wwdc2018/416/?time=520)

### [Instruments](https://developer.apple.com/videos/play/wwdc2018/416/?time=558)

Using the **Xcode&nbsp;Instruments** is the best way to look into the app's footprint: the **VM&nbsp;Tracker** (dirty and compressed memory) and the **VM&nbsp;Memory&nbsp;Trace** (virtual memory system's performance) are introduced to understand their purposes.

![](../../../../../images/iOSdev/wwdc18-416-ToolsInstruments.png)

### [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=621)

As noted sooner in the presentation, Xcode catches an **EXC resource exception** raised when the app's footprint reaches its limit.

![](../../../../../images/iOSdev/wwdc18-416-ToolsXcode_1.png)

The **Xcode&nbsp;Memory&nbsp;Debugger** has a [new&nbsp;design](https://developer.apple.com/videos/play/wwdc2018/416/?time=639) to exploit the Memgraph file format that stores some **information about the memory use**.

![](../../../../../images/iOSdev/wwdc18-416-ToolsXcode_2.png)

### Command-line

A number of the command-line tools can be used to analyze the Memgraphs in depth.

<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active"
           data-toggle="tab" 
           href="#ToolsCommandLineVmmap"
           id="ToolsCommandLineVmmap_tab"
           role="tab" 
           aria-selected="true">vmmap</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#ToolsCommandLineLeaks"
           id="ToolsCommandLineLeaks_tab"
           role="tab" 
           aria-selected="false">leaks</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#ToolsCommandLineHeap"
           id="ToolsCommandLineHeap_tab"
           role="tab" 
           aria-selected="false">heap</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#ToolsCommandLineMallocHistory"
           id="ToolsCommandLineMallocHistory_tab"
           role="tab" 
           aria-selected="false">malloc_history</a>
    </li>
</ul>

<div class="tab-content">
<div class="tab-pane show active" id="ToolsCommandLineVmmap" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=693">ðŸŽ¬ (11:33)</a>

This tool **displays the virtual memory regions** that are allocated to the process whether they're writable or not.

![](../../../../../images/iOSdev/wwdc18-416-ToolsCommandLineVmmap_1.png)

The **[awk&nbsp;scripts](https://developer.apple.com/videos/play/wwdc2018/416/?time=756)** are also recommended to be inserted in the command lines to provide more efficient and readible results.

![](../../../../../images/iOSdev/wwdc18-416-ToolsCommandLineVmmap_2.png)
</div>
<div class="tab-pane" id="ToolsCommandLineLeaks" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=808">ðŸŽ¬ (13:28)</a>

The `leaks` command-line exposes the objects responsible for the dirty memories that can't be released.

![](../../../../../images/iOSdev/wwdc18-416-ToolsCommandLineLeaks.png)
</div>
<div class="tab-pane" id="ToolsCommandLineHeap" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=854">ðŸŽ¬ (14:14)</a>

The `heap` tool displays all kind of information regarding the object allocations in the process heap.
 
![](../../../../../images/iOSdev/wwdc18-416-ToolsCommandLineHeap.png)
</div>
<div class="tab-pane" id="ToolsCommandLineMallocHistory" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=943">ðŸŽ¬ (15:43)</a>

In order to **log each object allocation in a Memgraph file**, the **malloc&nbsp;stack&nbsp;logging** must be ticked in the diagnostics tab within the scheme editor using the `Live`&nbsp;`Allocations`&nbsp;`only` option.

![](../../../../../images/iOSdev/wwdc18-416-ToolsCommandLineMallocHistory_1.png)

The allocation address passed as an input parameter to the `malloc_history` command-line will provide [useful&nbsp;information](https://developer.apple.com/videos/play/wwdc2018/416/?time=975) about the memory segments.

![](../../../../../images/iOSdev/wwdc18-416-ToolsCommandLineMallocHistory_2.png)
</div>
</div>

</br></br>
### [Choice](https://developer.apple.com/videos/play/wwdc2018/416/?time=1008)
The choice of the appropriate tool to use definitely depends on the goal to be reached.

![](../../../../../images/iOSdev/wwdc18-416-ToolsChoice.png)
</br></br>
## [Images](https://developer.apple.com/videos/play/wwdc2018/416/?time=1067)
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active"
           data-toggle="tab" 
           href="#ImagesOverview"
           id="ImagesOverview_tab"
           role="tab" 
           aria-selected="true">Overview</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#ImagesFormats"
           id="ImagesFormats_tab"
           role="tab" 
           aria-selected="false">Formats</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#ImagesSelection"
           id="ImagesSelection_tab"
           role="tab" 
           aria-selected="false">Selection</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link"
           data-toggle="tab" 
           href="#ImagesDownsampling"
           id="ImagesDownsampling_tab"
           role="tab" 
           aria-selected="false">Downsampling</a>
    </li>
</ul>

<div class="tab-content">
<div class="tab-pane show active" id="ImagesOverview" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=1070">ðŸŽ¬ (17:50)</a>

![](../../../../../images/iOSdev/wwdc18-416-ImagesOverview_1.png)

The [complete&nbsp;description](https://developer.apple.com/videos/play/wwdc2018/416/?time=1115) of the image processing is the basics to rule and understand the following steps of optimization.

![](../../../../../images/iOSdev/wwdc18-416-ImagesOverview_2.png)
</div>
<div class="tab-pane" id="ImagesFormats" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=1153">ðŸŽ¬ (19:13)</a>

The **understanding of the different formats** for images is the key to have a better perception of some later potential troublesome effects due to unfortunate initial settings.

![](../../../../../images/iOSdev/wwdc18-416-ImagesFormats.png)
</div>
<div class="tab-pane" id="ImagesSelection" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=1253">ðŸŽ¬ (20:53)</a>

The **recommended use of the API** will provide the most appropriate choice regarding the format.

![](../../../../../images/iOSdev/wwdc18-416-ImagesSelection_1.png)

Drawing a circle for a mask is the [suggested&nbsp;example](https://developer.apple.com/videos/play/wwdc2018/416/?time=1297) that exposes the reduce of memory usage with the above recommandations.

![](../../../../../images/iOSdev/wwdc18-416-ImagesSelection_2.png)
</div>
<div class="tab-pane" id="ImagesDownsampling" role="tabpanel">

<a alt="Click to playback the video at the indicated time." href="https://developer.apple.com/videos/play/wwdc2018/416/?time=1351">ðŸŽ¬ (22:31)</a>

![](../../../../../images/iOSdev/wwdc18-416-ImagesDownsampling_1.png)

To **avoid the memory spikes**, it's highly recommended to **use the ImageIO framework** when [loading&nbsp;an&nbsp;image](https://developer.apple.com/videos/play/wwdc2018/416/?time=1392) (displaying partial image during the loading process) or when its original size is huge.

![](../../../../../images/iOSdev/wwdc18-416-ImagesDownsampling_2.png)

While the CPU power is always operated in the downsampling process, it may be advisable to get the properly scaled image instead of initiating actions that will involve the processor to reach the same goal.
</div>
</div>

</br></br>
## [Background&nbsp;optimization](https://developer.apple.com/videos/play/wwdc2018/416/?time=1425)

![](../../../../../images/iOSdev/wwdc18-416-BackgroundOptimization_1.png)

![](../../../../../images/iOSdev/wwdc18-416-BackgroundOptimization_2.png)

**App lifecycle** and **view controllers appearance cycle** are the best places to handle the actions responsible for providing the most appropriate **memory space** to the system. 

![](../../../../../images/iOSdev/wwdc18-416-BackgroundOptimization_3.png)

![](../../../../../images/iOSdev/wwdc18-416-BackgroundOptimization_4.png)

</br></br>
## [Demo](https://developer.apple.com/videos/play/wwdc2018/416/?time=1540)

- Filter leaks in a Memgraph file âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=1676)

- Evaluate the number of potentially troublesome instances of objects âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=1715)

- Estimate the weigh of each generated objects (1/2) âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=1746)

- Estimate the weigh of each generated objects (2/2) âŸ¹ [vmmap&nbsp;--summary](https://developer.apple.com/videos/play/wwdc2018/416/?time=1791)

- Filter the memory allocation of a specific object âŸ¹ [vmmap&nbsp;|&nbsp;grep](https://developer.apple.com/videos/play/wwdc2018/416/?time=1914)

- Break down the contiguous regions of a big memory assignment âŸ¹ [vmmap&nbsp;--verbose](https://developer.apple.com/videos/play/wwdc2018/416/?time=1991)

- Reach the detailed information about a memory address âŸ¹ [leaks&nbsp;--traceTree](https://developer.apple.com/videos/play/wwdc2018/416/?time=2083)

- Filter the detailed information about a memory address âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=2166)

- Highlight a problematic VM region from a memory address (1/2) âŸ¹ [malloc-history&nbsp;--fullStacks](https://developer.apple.com/videos/play/wwdc2018/416/?time=2295)

- Highlight a problematic VM region from a memory address (2/2) âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=2371)

- Point out some problems using the memory report in the debug navigator âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=2443)

- Display the image memory size in the debugger âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=2556)

- Best code practice for scaling and rendering an image âŸ¹ [Xcode](https://developer.apple.com/videos/play/wwdc2018/416/?time=2725)

</br>

![](../../../../../images/iOSdev/wwdc18-416-Demo.png)
</br></br></br>